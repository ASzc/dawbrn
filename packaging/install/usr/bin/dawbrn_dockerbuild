#!/bin/bash

set -eEu

die() {
    echo "$@" >&2
    exit 1
}

source_clone="$(readlink -e "${1:?Specify a directory within /tmp/dawbrn/ to mount in the container}")"
[[ "$source_clone" =~ ^/tmp/dawbrn/ ]] || die "Given directory '$source_clone' is not within /tmp/dawbrn/"

td="$(mktemp -d)"
trap "rm -rf '$td'" EXIT
{
    echo "<settings>"
    echo "  <mirrors>"
    find /etc/dawbrn/maven-cache.d/ -type f -name '*.xml' | xargs -0 --no-run-if-empty cat
    echo "  </mirrors>"
    echo "</settings>"
} > "$td/settings.xml"
chown -R nobody: "$td"

docker run \
    --rm \
    --user nobody \
    -v "$source_clone:/tmp/build:z" \
    -v "$td:/tmp/m2:z" \
    --workdir /tmp/build \
    centos:7 \
    mvn clean prepare-package \
    -gs /tmp/m2/settings.xml \
    -B \
    -l mvn.log
